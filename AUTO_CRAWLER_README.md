# 🤖 کراول خودکار دیوار - راهنمای کامل

## 🎯 **هدف**
سیستم کراول خودکار که هر ساعت یکبار اجرا می‌شود و آگهی‌های جدید را از دیوار استخراج می‌کند.

## 🚀 **شروع سریع**

### **1. اجرای کراول خودکار**:
```bash
npm run auto-crawler
```

### **2. تست یکباره کراول**:
```bash
npm run auto-crawler:test
```

### **3. اجرای دستی**:
```bash
node src/auto-crawler.js
```

## ⚙️ **تنظیمات**

### **فایل کانفیگ**: `src/config/auto-crawler.js`

#### **📅 تنظیمات زمان‌بندی**:
```javascript
intervals: {
    hourly: 60 * 60 * 1000,        // هر ساعت
    every2Hours: 2 * 60 * 60 * 1000, // هر 2 ساعت
    every4Hours: 4 * 60 * 60 * 1000, // هر 4 ساعت
    every6Hours: 6 * 60 * 60 * 1000, // هر 6 ساعت
    daily: 24 * 60 * 60 * 1000      // روزانه
}

currentInterval: 'hourly' // تنظیم فعلی
```

#### **🏙️ شهرها و انواع آگهی**:
```javascript
targets: [
    { 
        city: 'tehran', 
        adType: 'buy-apartment', 
        displayName: 'تهران - خرید آپارتمان', 
        enabled: true 
    },
    // ... سایر شهرها
]
```

#### **⚡ تنظیمات کراول**:
```javascript
crawling: {
    timeout: 120000,           // 2 دقیقه تایم‌اوت برای هر شهر
    scrollDelay: 1000,         // 1 ثانیه تاخیر بین اسکرول‌ها
    waitBetweenCities: 5000,   // 5 ثانیه انتظار بین شهرها
    timeBasedStopping: {
        enabled: true,
        maxAge: '3 ساعت پیش',   // توقف در آگهی‌های قدیمی‌تر از 3 ساعت
        crawlOlderAds: false   // کراول نکردن آگهی‌های قدیمی
    }
}
```

## 🔧 **ویژگی‌های کلیدی**

### **1. کراول خودکار**:
- ✅ اجرای خودکار هر ساعت
- ✅ توقف هوشمند بر اساس زمان آگهی‌ها
- ✅ بررسی آگهی‌های تکراری
- ✅ ذخیره فوری در دیتابیس

### **2. مدیریت خطا**:
- ✅ تلاش مجدد در صورت شکست
- ✅ گزارش‌گیری کامل
- ✅ توقف ایمن در صورت خطا

### **3. نظارت و گزارش‌گیری**:
- ✅ ایمیل بعد از هر شهر
- ✅ ایمیل خلاصه نهایی
- ✅ آمار کامل دیتابیس
- ✅ لاگ‌گیری دقیق

### **4. تنظیمات انعطاف‌پذیر**:
- ✅ تغییر فاصله زمانی
- ✅ فعال/غیرفعال کردن شهرها
- ✅ تنظیم پارامترهای کراول
- ✅ شخصی‌سازی ایمیل‌ها

## 📊 **نحوه کارکرد**

### **مرحله 1: راه‌اندازی**
```
🤖 Starting Divar Auto-Crawler Service...
⏰ Will run every 60 minutes
🕐 Started at: [تاریخ و زمان]
```

### **مرحله 2: کراول اولیه**
```
🚀 Performing initial crawl...
📍 Processing: تهران - خرید آپارتمان
📊 Summary: [آمار]
📧 Email report sent
```

### **مرحله 3: کراول‌های زمان‌بندی شده**
```
🔄 Scheduled crawl triggered at [تاریخ و زمان]
📍 Processing: [شهر و نوع آگهی]
📊 Summary: [آمار]
```

## 📧 **سیستم ایمیل**

### **ایمیل‌های ارسالی**:

#### **1. ایمیل گزارش شهر**:
- بعد از هر شهر/نوع آگهی
- شامل: آمار کراول، مدت زمان، آگهی‌های جدید

#### **2. ایمیل خلاصه نهایی**:
- بعد از اتمام تمام کراول‌ها
- شامل: آمار کلی، وضعیت نهایی

### **تنظیمات ایمیل**:
```javascript
email: {
    enabled: true,                    // فعال/غیرفعال کردن ایمیل
    sendAfterEachCity: true,          // ایمیل بعد از هر شهر
    sendFinalSummary: true,           // ایمیل خلاصه نهایی
    includeDatabaseStats: true        // شامل آمار دیتابیس
}
```

## 🗄️ **مدیریت دیتابیس**

### **ذخیره اطلاعات**:
- ✅ **اطلاعات پایه**: عنوان و لینک (فوری)
- ✅ **جزئیات**: غیرفعال (فعلاً)
- ✅ **بررسی تکراری**: فعال
- ✅ **پشتیبان فایل**: فعال

### **ساختار ذخیره**:
```javascript
{
    title: "عنوان آگهی",
    link: "لینک آگهی",
    city: "شهر",
    adType: "نوع آگهی",
    createdAt: "تاریخ ایجاد"
}
```

## 🛠️ **عیب‌یابی**

### **مشکلات رایج**:

#### **1. خطای Chrome**:
```bash
# نصب Chrome
sudo apt update
sudo apt install google-chrome-stable

# تنظیم مسیر در کانفیگ
executablePath: '/usr/bin/google-chrome'
```

#### **2. خطای دیتابیس**:
```bash
# بررسی اتصال
npm run db:migrate

# بررسی مدل‌ها
node -e "require('./src/models').sequelize.authenticate().then(() => console.log('OK')).catch(console.error)"
```

#### **3. خطای ایمیل**:
```bash
# تست ایمیل
node src/test-email.js

# بررسی تنظیمات SMTP
src/config/email.js
```

### **لاگ‌ها**:
```bash
# مشاهده لاگ‌های زنده
npm run auto-crawler

# بررسی فایل لاگ (اگر فعال باشد)
tail -f auto-crawler.log
```

## 📈 **نظارت و آمار**

### **آمار قابل مشاهده**:
- 📊 تعداد کل آگهی‌ها
- 📊 آگهی‌های جدید هر اجرا
- ⏱️ مدت زمان کراول
- 🕐 زمان آخرین اجرا
- 📧 وضعیت ایمیل‌ها

### **گزارش‌های خودکار**:
- 📧 ایمیل بعد از هر شهر
- 📧 ایمیل خلاصه نهایی
- 📊 آمار دیتابیس
- ⚠️ گزارش خطاها

## 🔒 **امنیت و پایداری**

### **ویژگی‌های امنیتی**:
- ✅ توقف ایمن در صورت خطا
- ✅ تلاش مجدد خودکار
- ✅ بررسی سلامت سیستم
- ✅ مدیریت حافظه

### **تنظیمات پایداری**:
```javascript
performance: {
    maxConcurrentCities: 1,    // پردازش شهرها یکی یکی
    retryOnFailure: true,      // تلاش مجدد در صورت شکست
    maxRetries: 3,             // حداکثر 3 تلاش
    retryDelay: 30000          // 30 ثانیه تاخیر
}
```

## 📝 **مثال‌های کاربردی**

### **1. تغییر فاصله زمانی**:
```javascript
// در src/config/auto-crawler.js
currentInterval: 'every2Hours' // هر 2 ساعت
```

### **2. غیرفعال کردن شهر**:
```javascript
targets: [
    { city: 'tehran', adType: 'buy-apartment', enabled: false },
    // ... سایر شهرها
]
```

### **3. تغییر تنظیمات کراول**:
```javascript
crawling: {
    timeout: 180000,           // 3 دقیقه
    scrollDelay: 2000,         // 2 ثانیه
    waitBetweenCities: 10000   // 10 ثانیه
}
```

## 🚀 **شروع و توقف**

### **شروع سرویس**:
```bash
npm run auto-crawler
```

### **توقف سرویس**:
```bash
# در ترمینال اجرا شده
Ctrl + C

# یا از طریق کد
process.kill(process.pid, 'SIGINT')
```

### **تست بدون اجرای خودکار**:
```bash
npm run auto-crawler:test
```

## 📚 **فایل‌های مرتبط**

- **`src/auto-crawler.js`**: سرویس اصلی کراول خودکار
- **`src/config/auto-crawler.js`**: تنظیمات کراول خودکار
- **`src/services/databaseService.js`**: سرویس دیتابیس
- **`src/services/emailService.js`**: سرویس ایمیل
- **`src/services/crawlerService.js`**: سرویس کراول

## ✅ **نتیجه‌گیری**

سیستم کراول خودکار دیوار:
- 🤖 **خودکار** و **هوشمند** است
- ⏰ **هر ساعت** اجرا می‌شود
- 📧 **گزارش کامل** ارسال می‌کند
- 🗄️ **دیتابیس** را به‌روزرسانی می‌کند
- 🔒 **امن** و **پایدار** است

## 🎉 **آماده استفاده!**

```bash
npm run auto-crawler
```

سیستم شروع به کار می‌کند و هر ساعت آگهی‌های جدید را کراول می‌کند! 🚀
